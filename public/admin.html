<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotGirl.social - Admin Dashboard</title>
    <link rel="stylesheet" href="/public/assets/styles.css">
        
</head>
<body class="admin">
    <!-- Mobile menu toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        ‚ò∞ Menu
    </button>

    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="admin-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p><a href="https://hotgirl.social">hotgirl.Social</a></p>
            </div>
            <div class="sidebar-nav">
                <button class="nav-item active" onclick="showPage('dashboard')">
                    üìä Dashboard
                </button>
                <button class="nav-item" onclick="showPage('users')">
                    üë• Users & Profiles
                </button>
                <button class="nav-item" onclick="showPage('payments')">
                    üí≥ Payments
                </button>
                <button class="nav-item" onclick="showPage('messages')">
                    üìß Messages
                </button>
                <button class="nav-item" onclick="showPage('analytics')">
                    üìà Analytics
                </button>
                <button class="nav-item" onclick="showPage('settings')">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </nav>

        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Platform overview and key metrics</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-profiles">0</div>
                        <div class="stat-label">Active Profiles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-revenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthly-signups">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                    </div>
                    <div class="card-content">
                        <div id="recent-activity" class="loading">
                            <div class="spinner"></div>
                            Loading recent activity...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Users & Profiles Page -->
            <div id="users" class="page">
                <div class="page-header">
                    <h1 class="page-title">Users & Profiles</h1>
                    <p class="page-subtitle">Manage all registered users and their profiles</p>
                </div>

                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search users..." id="user-search">
                    <button class="btn btn-primary" onclick="searchUsers()">Search</button>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">All Users</h3>
                    </div>
                    <div class="card-content">
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Display Name</th>
                                        <th>Email</th>
                                        <th>Joined</th>
                                        <th>Links</th>
                                        <th>Views</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <tr>
                                        <td colspan="8" class="loading">
                                            <div class="spinner"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Page -->
            <div id="payments" class="page">
                <div class="page-header">
                    <h1 class="page-title">Payment Management</h1>
                    <p class="page-subtitle">Track all payments and transactions</p>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Payments</h3>
                    </div>
                    <div class="card-content">
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Stripe ID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table">
                                    <tr>
                                        <td colspan="5" class="loading">
                                            <div class="spinner"></div>
                                            Loading payments...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Page -->
            <div id="messages" class="page">
                <div class="page-header">
                    <h1 class="page-title">Contact Messages</h1>
                    <p class="page-subtitle">View and respond to user inquiries</p>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">All Messages</h3>
                    </div>
                    <div class="card-content">
                        <div id="messages-container" class="loading" style="padding: 40px;">
                            <div class="spinner"></div>
                            Loading messages...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics" class="page">
                <div class="page-header">
                    <h1 class="page-title">Platform Analytics</h1>
                    <p class="page-subtitle">Detailed platform performance metrics</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-views">0</div>
                        <div class="stat-label">Total Page Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-clicks">0</div>
                        <div class="stat-label">Total Link Clicks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-links">0</div>
                        <div class="stat-label">Avg Links/Profile</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="conversion-rate">0%</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Growth Over Time</h3>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <p style="text-align: center; color: #666; padding: 50px;">
                                Chart visualization would go here<br>
                                <small>(Integration with Chart.js or similar library)</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
        <div class="content-card">
        <div class="card-header">
            <h3 class="card-title">General Settings</h3>
        </div>
        <div class="card-content" style="padding: 30px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Platform Name</label>
                <input type="text" id="platform-name" value="hotgirl.social" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Registration Price</label>
                <input type="number" id="registration-price" value="29" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Maximum Links per Profile</label>
                <input type="number" id="max-links" value="20" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            <button class="btn btn-primary" id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>











            </div>
        </main>
    </div>

    <!-- User View Modal -->
    <div id="user-modal" class="modal-overlay">
        <div class="user-modal">
            <div class="modal-header">
                <h2 id="modal-title">User Profile Review</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-content">
                <div class="loading" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    Loading user data...
                </div>
            </div>
        </div>
    </div>



    

<script>

        let API_BASE_URL = null; // Will be set after loading config
        let adminToken = localStorage.getItem('adminToken');

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(adminToken && { 'Authorization': `Bearer ${adminToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        adminToken = null;
                        showLoginForm();
                        throw new Error('Authentication required');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        function showLoginForm() {
            document.querySelector('.admin-container').classList.remove('authenticated');
            const loginHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 400px; width: 90%;">
                        <h2 style="text-align: center; margin-bottom: 30px;">Admin Login</h2>
                        <form id="admin-login-form">
                            <div style="margin-bottom: 20px;">
                                <label>Email:</label>
                                <input type="email" id="admin-email" required>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label>Password:</label>
                                <input type="password" id="admin-password" required>
                            </div>
                            <button type="submit">Login</button>
                            <div id="login-error" style="color: red; display: none;"></div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', loginHtml);
            
            document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const errorDiv = document.getElementById('login-error');
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        adminToken = data.token;
                        localStorage.setItem('adminToken', adminToken);
                        document.querySelector('[style*="position: fixed"]').remove();
                        initializeDashboard();
                    } else {
                        const error = await response.json();
                        errorDiv.textContent = error.error || 'Login failed';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    errorDiv.textContent = 'Connection error. Is your server running?';
                    errorDiv.style.display = 'block';
                }
            });
        }

        function checkAuthStatus() {
            if (!adminToken) {
                showLoginForm();
                return false;
            }
            return true;
        }

        async function initializeDashboard() {
            document.querySelector('.admin-container').classList.add('authenticated');
            try {
                const stats = await apiCall('/api/admin/stats');
                document.getElementById('total-users').textContent = stats.totalUsers || 0;
                document.getElementById('active-profiles').textContent = stats.activeProfiles || 0;
                document.getElementById('total-revenue').textContent = `$${(stats.totalRevenue || 0).toLocaleString()}`;
                document.getElementById('monthly-signups').textContent = stats.monthlySignups || 0;
                loadRecentActivity();
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
                showError('Failed to load dashboard data.');
            }
        }

        async function loadRecentActivity() {
            try {
                const activityData = await apiCall('/api/admin/activity');
                const container = document.getElementById('recent-activity');
                if (activityData.activity && activityData.activity.length > 0) {
                    container.innerHTML = activityData.activity.map(item => `
                        <div>
                            <span>‚úì</span> ${item.message}
                            <div>${new Date(item.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div>No recent activity</div>';
                }
            } catch (error) {
                document.getElementById('recent-activity').innerHTML = '<div>Failed to load activity</div>';
            }
        }

        async function loadUsers() {
            try {
                const [usersData, profilesData] = await Promise.all([
                    apiCall('/api/admin/users'),
                    apiCall('/api/admin/profiles')
                ]);
                // ... unchanged rendering logic ...
            } catch (error) {
                document.getElementById('users-table').innerHTML = '<tr><td colspan="8">Failed to load users</td></tr>';
            }
        }

        async function viewUser(userId) {
            try {
                const usersData = await apiCall('/api/admin/users');
                const user = usersData.users.find(u => u.id === userId);
                let profileData = {};
                try {
                    const profilesData = await apiCall('/api/admin/profiles');
                    const profile = profilesData.profiles.find(p => p.username === user.username);
                    if (profile) profileData = profile;
                } catch {}
                // ... unchanged modal rendering ...
            } catch (error) {
                alert(`Error loading user data: ${error.message}`);
            }
        }

        function viewPublicProfile(username) {
            window.open(`${API_BASE_URL}/${username}`, '_blank');
        }

        async function toggleUserStatusFromModal(userId, newStatus) {
            try {
                await apiCall(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: newStatus })
                });
                showSuccessMessage(`User ${newStatus ? 'activated' : 'suspended'} successfully`);
                closeUserModal();
                loadUsers();
            } catch {
                showError('Failed to update user status');
            }
        }

        async function loadPayments() {
            try {
                const data = await apiCall('/api/admin/payments');
                // ... unchanged rendering logic ...
            } catch {
                document.getElementById('payments-table').innerHTML = '<tr><td colspan="5">Failed to load payments</td></tr>';
            }
        }

        async function loadMessages() {
            try {
                const data = await apiCall('/api/admin/messages');
                // ... unchanged rendering logic ...
            } catch {
                document.getElementById('messages-container').innerHTML = '<div>Failed to load messages</div>';
            }
        }

        async function loadAnalytics() {
            try {
                const stats = await apiCall('/api/admin/stats');
                document.getElementById('total-views').textContent = (stats.totalViews || 0).toLocaleString();
                document.getElementById('total-clicks').textContent = (stats.totalClicks || 0).toLocaleString();
                document.getElementById('avg-links').textContent = stats.avgLinks || '0';
                document.getElementById('conversion-rate').textContent = `${stats.conversionRate || 0}%`;
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function showPage(pageId) {
            closeMobileMenu();
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            switch(pageId) {
                case 'dashboard': initializeDashboard(); break;
                case 'users': loadUsers(); break;
                case 'payments': loadPayments(); break;
                case 'messages': loadMessages(); break;
                case 'analytics': loadAnalytics(); break;
                case 'settings': loadSettings(); break;
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                await apiCall(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: newStatus })
                });
                showSuccessMessage(`User ${newStatus ? 'activated' : 'suspended'} successfully`);
                loadUsers();
            } catch {
                showError('Failed to update user status');
            }
        }

        async function markAsRead(messageId) {
            try {
                await apiCall(`/api/admin/messages/${messageId}/read`, { method: 'PUT' });
                showSuccessMessage('Message marked as read');
                loadMessages();
            } catch {
                showError('Failed to mark message as read');
            }
        }

        async function loadUsersWithSearch(searchTerm) {
            try {
                const [usersData, profilesData] = await Promise.all([
                    apiCall(`/api/admin/users?search=${encodeURIComponent(searchTerm)}`),
                    apiCall('/api/admin/profiles')
                ]);
                // ... unchanged rendering logic ...
            } catch {
                document.getElementById('users-table').innerHTML = '<tr><td colspan="8">Search failed</td></tr>';
            }
        }

        async function loadSettings() {
            try {
                const data = await apiCall('/api/admin/settings');
                // ... unchanged settings form fill ...
            } catch {
                console.error('Failed to load settings');
            }
        }

        async function saveSettings() {
            try {
                const platformName = document.querySelector('input[value*="hotgirl"]').value;
                const registrationPrice = document.querySelector('input[type="number"]').value;
                const maxLinks = document.querySelector('input[value="20"]').value;
                await apiCall('/api/admin/settings', {
                    method: 'POST',
                    body: JSON.stringify({
                        platform_name: platformName,
                        registration_price: registrationPrice,
                        max_links_per_profile: maxLinks
                    })
                });
                showSuccessMessage('Settings saved successfully!');
            } catch {
                showError('Failed to save settings');
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();
            if (checkAuthStatus()) {
                initializeDashboard();
            }
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                API_BASE_URL = config.apiUrl;
            } catch {
                API_BASE_URL = 'https://hotgirl-social-production.up.railway.app';
            }
        }

</script>

    </body>
</html>